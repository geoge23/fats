name: Build and Push to GHCR

on:
    push:
        branches:
            - main
            - master
    pull_request:
        branches:
            - main
            - master

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
              with:
                  name: buildkit

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Install railpack
              run: |
                  curl -fsSL https://railpack.com/install.sh | sh
                  echo "$HOME/.railpack/bin" >> $GITHUB_PATH

            - name: Build with railpack
              run: |
                  export BUILDKIT_HOST=docker-container://buildkit
                  railpack build .

            - name: Tag and push image to GHCR
              run: |
                  IMAGE_ID="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
                  IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

                  # Get the railpack built image
                  RAILPACK_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "^fats:" | head -n 1)

                  # Tag and push each metadata tag
                  echo "${{ steps.meta.outputs.tags }}" | while read -r tag; do
                    docker tag $RAILPACK_IMAGE $tag
                    docker push $tag
                  done

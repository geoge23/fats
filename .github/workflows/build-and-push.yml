name: Build and Push to GHCR

on:
    push:
        branches:
            - main
            - master
    pull_request:
        branches:
            - main
            - master

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Install railpack
              run: |
                  curl -fsSL https://railpack.com/install.sh | sh
                  echo "$HOME/.railpack/bin" >> $GITHUB_PATH

            - name: Start BuildKit
              run: |
                  docker run -d --name buildkit --privileged moby/buildkit:latest
                  sleep 2

            - name: Build with railpack
              run: |
                  set -e
                  export BUILDKIT_HOST=docker-container://buildkit
                  railpack build . --platform linux/amd64 --name fats:amd64-working &
                  pid1=$!
                  railpack build . --platform linux/arm64 --name fats:arm64-working &
                  pid2=$!
                  wait "$pid1"
                  wait "$pid2"

            - name: Tag and push image to GHCR
              run: |
                  IMAGE_ID="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
                  IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

                  docker tag fats:amd64-working "${IMAGE_ID}:amd64-working"
                  docker tag fats:arm64-working "${IMAGE_ID}:arm64-working"

                  # Push and get digests
                  docker push "${IMAGE_ID}:amd64-working" | tee /tmp/amd64-push.log
                  docker push "${IMAGE_ID}:arm64-working" | tee /tmp/arm64-push.log

                  AMD_DIGEST=$(grep -oP 'digest: \K[^ ]+' /tmp/amd64-push.log | tail -n1)
                  ARM_DIGEST=$(grep -oP 'digest: \K[^ ]+' /tmp/arm64-push.log | tail -n1)

                  # Create and push manifests for each metadata tag
                  echo "${{ steps.meta.outputs.tags }}" | while read -r tag; do
                    TAG_NAME=$(echo "$tag" | sed "s|${IMAGE_ID}:||")
                    docker manifest create "${IMAGE_ID}:${TAG_NAME}" \
                      --amend "${IMAGE_ID}@${AMD_DIGEST}" \
                      --amend "${IMAGE_ID}@${ARM_DIGEST}"
                    docker manifest push "${IMAGE_ID}:${TAG_NAME}"
                  done
